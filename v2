"use client";

import {
  createColumnHelper,
  useReactTable,
  getCoreRowModel,
  flexRender,
  getFilteredRowModel,
} from "@tanstack/react-table";
import { useState } from "react";
import axios from "axios";
import { useUser } from "../context/UserContext";
import KeyPoint from "@/components/KeyPoint/KeyPoint";
import CardButton from "@/components/CardButton/CardButton";
import VisitTracker from "@/components/VisitTracker/VisitTracker";
import { root } from "@/server-config";

export default function Table() {
  const {
    excelDownloadPath,
    fmsTable,
    model1Path,
    model1SW,
    model1CL,
    model2Path,
    model2SW,
    model2CL,
    prefix,
    reference,
  } = useUser();

  const { HEADERS: column_heading, DATA_ROWS_AFTER_COLORING: Data } = fmsTable;

  const [globalFilter, setGlobalFilter] = useState("");

  // ✅ columns created dynamically
  const columns: any[] = [];
  for (let i = 0; i < column_heading.length; i++) {
    columns.push({
      accessorKey: column_heading[i],
      header: column_heading[i],
    });
  }

  const firstColumnId = column_heading[0]; // ✅ FIRST COLUMN ID

  const table = useReactTable({
    data: Data,
    columns,
    state: {
      globalFilter,
      columnPinning: {
        left: [firstColumnId], // ✅ PIN FIRST COLUMN
      },
    },
    onGlobalFilterChange: setGlobalFilter,
    getCoreRowModel: getCoreRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
  });

  const handleDownloadExcel = async () => {
    const query = `${root}/getFile?path=${excelDownloadPath}`;
    try {
      const response = await axios.get(query, { responseType: "blob" });
      const FileUrl = response.config.url!;
      const filename = FileUrl.split("/").pop()!;
      const url = window.URL.createObjectURL(new Blob([response.data]));
      const link = document.createElement("a");
      link.href = url;
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      link.remove();
    } catch (e: any) {
      console.log("Excel download error:", e);
    }
  };

  return (
    <div style={{ overflowX: "auto" }}>
      <VisitTracker page={"result"} />

      {model1CL != null && (
        <KeyPoint
          mainPoint="Model 1 CL"
          description={model1CL === 0 ? "Latest" : model1CL}
        />
      )}

      {model2CL != null && (
        <KeyPoint
          mainPoint="Model 2 CL"
          description={model2CL === 0 ? "Latest" : model2CL}
        />
      )}

      <input
        value={globalFilter ?? ""}
        onChange={(e) => setGlobalFilter(e.target.value)}
        placeholder="Search FMS KEY..."
        style={{
          marginBottom: "10px",
          padding: "6px 10px",
          border: "1px solid #ccc",
        }}
      />

      <CardButton
        label={"Download Excel"}
        buttonColor={"green"}
        onClick={handleDownloadExcel}
      />

      <table
        style={{
          borderCollapse: "collapse",
          width: "100%",
          minWidth: "1000px",
          fontFamily: "sans-serif",
          fontSize: "14px",
          backgroundColor: "white",
        }}
      >
        <thead>
          {table.getHeaderGroups().map((headerGroup) => (
            <tr key={headerGroup.id}>
              {headerGroup.headers.map((header) => {
                const isPinned = header.column.getIsPinned();

                return (
                  <th
                    key={header.id}
                    style={{
                      border: "1px solid #ccc",
                      padding: "8px",
                      textAlign: "left",
                      backgroundColor: "#f9f9f9",
                      position: isPinned ? "sticky" : "static",
                      left: isPinned ? 0 : undefined,
                      zIndex: isPinned ? 3 : 1,
                    }}
                  >
                    {flexRender(
                      header.column.columnDef.header,
                      header.getContext()
                    )}
                  </th>
                );
              })}
            </tr>
          ))}
        </thead>

        <tbody>
          {table.getRowModel().rows.map((row) => (
            <tr key={row.id}>
              {row.getVisibleCells().map((cell) => {
                const isPinned = cell.column.getIsPinned();

                const overrideColor = row.original.colors?.includes(
                  cell.column.id
                )
                  ? "lightpink"
                  : "white";

                return (
                  <td
                    key={cell.id}
                    style={{
                      border: "1px solid #ddd",
                      padding: "8px",
                      backgroundColor: overrideColor,
                      position: isPinned ? "sticky" : "static",
                      left: isPinned ? 0 : undefined,
                      zIndex: isPinned ? 2 : 1,
                    }}
                  >
                    {flexRender(
                      cell.column.columnDef.cell,
                      cell.getContext()
                    )}
                  </td>
                );
              })}
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}