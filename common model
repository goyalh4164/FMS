"use client";

import { useState, useEffect, useMemo } from "react";
import SelectInput from "../SelectInput/SelectInput";
import RadioGroup from "../RadioGroup/RadioGroup";
import TextInput from "../TextInput/TextInput";
import SmoothWrapper from "../SmoothWrapper/SmoothWrapper";
import styles from "./CommonInputCard.module.css";
import { root } from "@/server-config";
import axios from "axios";
import { toast } from "react-toastify";
import Colors from "@/constants/Colors";

export default function CommonInputCard({ Heading, index, onDataChange }) {
  const [branch, setBranch] = useState("");
  const [lastBranch, setLastBranch] = useState("");
  const [product, setProduct] = useState("");
  const [productOptions, setProductOptions] = useState([]);
  const [chipset, setChipset] = useState("");
  const [changelistType, setChangelistType] = useState("latest");
  const [changelistNumber, setChangelistNumber] = useState("");
  const [chipsetOptions, setChipsetOptions] = useState([]);
  const [pathOfSoftwareModel, setPathOfSoftwareModel] = useState("");
  const [pathForChipset, setPathForChipset] = useState("");
  const [loadingProduct, setLoadingProduct] = useState(false);
  const [loadingChipset, setLoadingChipset] = useState(false);

  /* ------------------ Branch Blur ------------------ */
  const handleBranchBlur = async (value) => {
    if (!value || lastBranch === value) return;

    setBranch(value);
    setLastBranch(value);
    setLoadingProduct(true);
    setProduct("");
    setChipset("");
    setProductOptions([]);
    setChipsetOptions([]);

    try {
      const response = await axios.get(`${root}/getProducts?path=${value}`);
      const { path, dir_names } = response.data.data;

      setPathForChipset(path);

      setProductOptions(
        dir_names.map((d) => ({ value: d, label: d }))
      );
    } catch (e) {
      toast.error("Invalid Branch Path");
    } finally {
      setLoadingProduct(false);
    }
  };

  /* ------------------ Product Change ------------------ */
  const handleProductChange = async (value) => {
    if (!value) return;

    setProduct(value);
    setChipset("");
    setLoadingChipset(true);

    try {
      const response = await axios.get(
        `${root}/getChipsets?path=${pathForChipset}${value}`
      );

      const { path, dir_names } = response.data.data;
      setPathOfSoftwareModel(path);

      setChipsetOptions(
        dir_names.map((d) => ({ value: d, label: d }))
      );
    } catch (e) {
      toast.error("Unable to fetch chipset models");
    } finally {
      setLoadingChipset(false);
    }
  };

  /* ------------------ Chipset ------------------ */
  const handleChipsetChange = (value) => setChipset(value);

  /* ------------------ DERIVED deltaPath (FIX) ------------------ */
  const deltaPath = useMemo(() => {
    if (!pathOfSoftwareModel || !chipset) return "";
    return `${pathOfSoftwareModel}${chipset}/`;
  }, [pathOfSoftwareModel, chipset]);

  /* ------------------ Notify Parent ------------------ */
  useEffect(() => {
    const cardData = {
      branch,
      product,
      chipset,
      changelistType,
      changelistNumber:
        changelistType === "specific" ? changelistNumber : null,
      deltaPath,
    };

    onDataChange?.(index, cardData);
  }, [
    branch,
    product,
    chipset,
    changelistType,
    changelistNumber,
    deltaPath,
  ]);

  return (
    <div
      className={styles.container}
      style={{ backgroundColor: Colors.cardBackgroundColor }}
    >
      <div className={styles.heading_container}>
        <h1>{Heading}</h1>
      </div>

      {/* Branch */}
      <TextInput
        id={`branch-${index}`}
        label="Branch"
        placeholder="Enter Branch"
        defaultValue={branch}
        onBlur={handleBranchBlur}
      />
      <p style={{ marginTop: 0, fontSize: "0.77em", color: "blue" }}>
        ***Enter the branch path just before [ feature-config-data ]
      </p>

      {/* Product */}
      <SelectInput
        id={`product-${index}`}
        label="Product"
        value={product}
        onChange={handleProductChange}
        loading={loadingProduct}
        disabled={!branch || productOptions.length === 0}
        options={productOptions}
      />

      {/* Chipset */}
      <SelectInput
        id={`chipset-${index}`}
        label="Chipset"
        value={chipset}
        loading={loadingChipset}
        onChange={handleChipsetChange}
        disabled={chipsetOptions.length === 0}
        options={chipsetOptions}
      />

      {/* Changelist */}
      <RadioGroup
        name={`changelist-${index}`}
        value={changelistType}
        onChange={setChangelistType}
        options={[
          {
            id: `latest-cl-${index}`,
            label: "Latest Changelist",
            value: "latest",
          },
          {
            id: `specific-cl-${index}`,
            label: "Specific Changelist",
            value: "specific",
          },
        ]}
      />

      {/* Specific Changelist */}
      <SmoothWrapper show={changelistType === "specific"}>
        <TextInput
          id={`changelist-number-${index}`}
          label="Changelist"
          placeholder="Enter Changelist"
          value={changelistNumber}
          onChange={setChangelistNumber}
        />
      </SmoothWrapper>
    </div>
  );
}